# 트랜잭션 격리와 발생하는 상황

### MySql의 기본 격리 수준

반복 읽기 (Repeatable Read)

- 최초 커밋된 데이터를 읽어 온다.
- 이 시점에서는 커밋된 읽기 (Read Commited)와 같다.

커밋된 읽기 (Read Commited)

- 쿼리를 실행한 시점에서 커밋된 데이터를 읽어 들인다.

### 갱신과 참조는 NON BLOCK

### 갱신과 갱신은 BLOCK

- 잠금 타임아웃이 발생하며 부가적으로 교착 상대가 발생한다.
- `잠금 타임아웃`
    - 갱신과 갱신이 부딪혀 나중에 실행된 갱신이 잠금 대기 상태가 되는 현상이다.
    - 잠긴 쪽은 언제 잠금이 풀지 알 수 없다.
    - `교착상태`
        - 서로 다른 트랜잭션이 테이블 a에 대한 락을 얻어다 가정
            - 잠금이 필요한 처리를 실행해도 아무런 상황이 바뀌지 않는 상태
        - 빈도를 낮추는 대책
            - DBMS 전반적인 대책
                - 트랜잭션을 작은 단위로 커밋
                - 정해진 순서로 테이블에 엑세스한다.
                - 필요 없는 읽기 잠금 흭득 사용을 피한다.
                - 쿼리에 의한 잠금 범위를 더 좁히거나 잠금 정도를 작은 것으로 한다.
                - 한 테이블의 복수 행을 복수의 연결에서 순서 변경 없이 갱신하면 교착 상태가 발생하기 쉽다. 자주 발생하는 테이블 단위의 잠금을 흭득해 갱신을 직렬화하면 동시성을 떨어지지만 교착 상태는 회피할 수 있어 전체 처리에선 좋을 수 있다.
            - MySQL 대책
                - 테이블에 적절한 인덱스를 추가해 쿼리가 이를 이용하게 한다.
                - 인덱스가 사용되지 않는 경우에는 필요한 행의 잠금이 아닌 스캔한 행 전체에 대해 잠금이 걸리게 된다.

### 주의해야 하는 트랜잭션 처리

- 오토 커밋
- 긴 트랜잭션
    - 대량 처리를 한 개의 트랜잭션이 실행
    - 아무것도 하지 않는 트랜잭션을 유의
    - 트랜잭션 중에 대화 처리를 넣는다.
    - 처리 능력 이상의 트랜잭션 수
- 시스템 성능에 맞게 기본 값으로 되어 있는 트랜잭션을 설정해야 한다.