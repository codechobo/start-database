# 데이터베이스와 아키텍처 구성

## 다중화에 대해 생각해보자

### 다중화 (고가용성)

- DB서버가 2대 있다면 1대가 고장 난다 하더라도 나머지 1대가 동작하면 서비스의 정지를 막을 수 있는데, 이것을 다중화라고 한다.

## 아키텍처란

- 시스템을 만들기 위한 물리 레벨의 조합 이란 의미로 사용된다.
- 구체적으로 ‘어떤 기능을 가진 서버를 준비하고 어떠한 저장소나 네트워크 기기와 조합해서 시스템 전체를 만들 것인가’ 즉 하드웨어와 미들웨어의 구성을 가리킨다.

### 아키텍처의 역사

- Stand-alone (~1980년대)
- 클라이언트/서버 (1990년대 ~ 2000년)
- Web 3계층 ( 현재 )

### Stand-alone 특징

- 서버가 네트워크에 접속되어 있지 않아 , 즉 독립적으로 동작이 되어 물리적으로 떨어진 장소에서 엑세스하는 것이 불가능하다.
- 단점
    1. 물리적으로 떨어진 장소에서 접근할 수 없다.
    2. 복수 사용자가 동시에 작업할 수 없다.
    3. 가용성이 낮다.
    4. 확장성이 부족하다.
- 장점
    1. 구축이 매우 간단해 소규모 작업이나 테스트를 빨리할 수 있다.
    2. 독립된 구조로 구성되어 보안이 높다.

### 클라이언트/서버 특징

- 클라이언트와 서버의 계층으로 구성하여 네트워크으로 접속하는 방식
- 단점
    1. 네트워크에서 직접 데이터베이스에 접속하는 것에 대한 보안 위험
    2. 개인 PC에 애플리케이션을 설치해 동작
        1. 버버전관리나 버그 수정 버전을 배포하는 데 비현실적인 비용이 필요


### Web 3계층의 특징

- 클라이언트와 데이터베이스 계층 사이에 ‘웹 서버 계층’과 ‘애플리케이션 계층’을 추가한 방식이다.
- 웹서버 계층
    - 웹서버는 클라이언트로부터 접속 요청(HTTP 요청)을 직접 받아서 그 처리를 뒷단의 계층에 넘기고 그 결과를 클라이언트에 반환한다.
- 애플리케이션 계층
    - 비즈니스 로직을 구현한 애플리케이션이 동작하는 층이다.
    - 웹 서버로부터 연계된 요청을 처리하고, 필요하면 데이터베이스 계층에 접속해서 데이터를 추출하고 이를 가공한 결과를 웹서로 반환한다.

---

### 가용성과 확장성의 확보

- 가용성을 높이는 2가지 전략
    - 심장전략
        - 시스템을 구성하는 각 컴포넌트의 신뢰성을 높여 장애 발생률을 낮게 억제해서 가용성을 높인다.
    - 신장전략
        - 시스템을 구성하는 각 컴포넌트의 실뢰성을 계속해서 높이기보다는 사물은 언제가 망가진다란 체념을 전제로 여분을 준비해 둔다.
        - 물량작전이라고도 한다.

### 클러스터란

- 신장전략처럼 동일한 기능의 컴포넌트를 병렬화하는 것을 클러스터링이라고 한다.
- 동일한 기능의 컴포넌트를 복수 개 준비해 한 개의 기능을 실현한다.

### 단일 장애점

- 다중화되어 있지 않아 시스템 전체 서비스의 계속성에 영향을 주는 컴포넌트를 단일 장애점이라 한다.
- 단일 장애점의 신뢰성이 시스템 전체의 가용성을 결정한다.

---

## DB 서버의 다중화 - 클러스터링

- 다중화를 할 때 데이터를 보존하는 영속 계층을 고려해야 한다.
- 데이터는 항상 갱신되기 때문에 다중화를 유지하는 중에 데이터 정합성도 중요하게 의식해야 한다.

### 기본적인 다중화

- DB 서버 (N) : 저장소 (1) N:1
- DB 서버 N개가 동시에 동작하는 것을 허락할지에 따라 Active-Active 와 Active-Standby로 나뉜다.
- Active-Active
    - 클러스터를 구성하는 컴포넌트를 동시에 가동한다.
    - 장점
        1. 시스템 다운 시간이 짧다
            1. 복수의 DB 서버가 동시에 동작하고 있어서 한 댁가 다운되어 동작 불능이 되도 남은 서버가 처리를 계속해 시스템 전체가 정지하는 것을 방지할 수 있다.
        2. 성능이 좋다.
            1. DB 서버 대수가 증가하면 동시에 가동하는 CPU나 메모리도 증가하기 때문에 성능도 향상될 수 있다.
            2. 단, 저장소가 병목이 되기 때문에 생각한 만큼 성능이 향상되지 않는 경우도 있다.
- Active-Standby
    - 클러스터를 구성하는 컴포넌트 중 실제 가동하는 것은 Active, 남은 것은 대기(Standby)하고 있는다.
    - HeartBeat
        - Active DB 서버에게 일정 간격으로 이상이 없는지 통신을 한다.
    - 단점
        - 다운 상태가 된다.
            - Active DB 서버에서 장애가 일어날 때 Standby DB 서버를 Active 상태로 변환하고 동작하게 되는데 전환되는 상황에 시차가 생겨 그사이 시스템은 서비스를 계속하는 것이 불가능한 상태가 된다.
    - 구성
        - Cold-Standby
            - 평소에는 Standby DB가 작동하지 않다가 Active DB가 다운된 시점에 Standby가 작동
        - Hot-Standby
            - 평소에도 Standby DB가 작동한다.

### 리플리케이션

- DB 서버와 저장소 세트를 복수로 준비하는 것을 말한다.
    - DB 서버뿐만 아니라 데이터도 다중화한다.
- 주의할 점
    - Active 측 저장소의 데이터는 항상 사용자로부터 갱신된다.
        - 이 때문에 Standby 측 데이터에도 갱신을 반영해야한다.
        - 반영하지 않으면 데이터 정합성을 유지할 수 없다.


### 마스터 슬레이브 방식

- 마스터와 슬레이브에 따른 리플리케이션
- 마스터
    - 동기화하는 측의 부모(Active) 데이터베이스
- 슬레이브
    - 동기화되는 측의 자식(Standby) 데이터베이스

### 성능을 추구하기 위한 다중화

- Shared Disk 와 Shared Nothing
- Shared Disk
    - 북수의 서버가 1대의 디스크를 사용하는 구성하는 방식
    - 저장소를 공유하여 사용하기에 오버헤드가 크다.
    - 복잡한 동기화 구조
- Shared Nothing
    - ‘아무것도 공유하지 않는다’라는 의미로 네트워크 이외의 자원을 모두 분리하는 방식이다.
    - 서버와 저장소의 세트를 늘리면 병렬처리 때문에 선형적으로 성능이 향상되는 장점이 있다.
    - 간단한 구조
    - DB 서버가 다운되었을 때 다른 DB 서버가 이를 이어받아 계속 처리할 수 있게 하는 커버링 구성을 고려해야함d